#!/usr/bin/make -f
MAKEFILE = $(firstword $(MAKEFILE_LIST))
DEBIAN_DIR = $(dir $(MAKEFILE))
DEBIAN_DIR_ABS = $(abspath $(DEBIAN_DIR))
TEMP_HOME = $(DEBIAN_DIR_ABS)/homedir/

override_dh_clean:
	rm -rf $(TEMP_HOME)
	dh_clean

override_dh_auto_build:
	# The Mono guys used cibuild_bootstrapped_msbuild.sh to get MSBuild to build itself.
	# However, it doesn't work in Microsoft's MSBuild as it tries to call "msbuild". What
	# if it was run on a schroot? Offending command:
	# HOME=$(TEMP_HOME) ./msbuild/eng/cibuild_bootstrapped_msbuild.sh --host_type mono --configuration Release /p:DisableNerdbankVersioning=true /p:Test=false
	mkdir -p $(TEMP_HOME)
	HOME=$(TEMP_HOME) ./msbuild/build.sh --restore --build --configuration Release-MONO /p:DisableNerdbankVersioning=true

override_dh_auto_install:
	mkdir -p debian/tmp/usr/bin
	mkdir -p debian/tmp/usr/lib/mono/msbuild/Current/bin
	mkdir -p debian/tmp/usr/lib/mono/xbuild/Current
	mkdir -p debian/tmp/usr/lib/mono/xbuild/Microsoft
	ln -s Current debian/tmp/usr/lib/mono/msbuild/15.0
	ln -s Current debian/tmp/usr/lib/mono/xbuild/15.0
	cp debian/msbuild_init debian/tmp/usr/bin/msbuild
	cp -R msbuild/artifacts/bin/MSBuild/Release-MONO/net472/* debian/tmp/usr/lib/mono/msbuild/Current/bin/
	cp msbuild/artifacts/bin/MSBuild/Release-MONO/net472/Microsoft.VisualStudioVersion.*.Common.props debian/tmp/usr/lib/mono/xbuild/Current/
	cp msbuild/artifacts/bin/MSBuild/Release-MONO/net472/Microsoft.Common.props debian/tmp/usr/lib/mono/xbuild/Current/

override_dh_clideps:
	dh_clideps \
		--exclude-moduleref=api-ms-win-core-file-l1-1-0.dll \
		--exclude-moduleref=api-ms-win-core-localization-l1-2-0.dll \
		--exclude-moduleref=api-ms-win-core-sysinfo-l1-1-0.dll \
		--exclude-moduleref=api-ms-win-core-sysinfo-l1-2-0.dll \
		--exclude-moduleref=axnative.dll \
		--exclude-moduleref=clr \
		--exclude-moduleref=crypt32.dll \
		--exclude-moduleref=dbghelp.dll \
		--exclude-moduleref=fusion \
		--exclude-moduleref=fusion.dll \
		--exclude-moduleref=hostfxr \
		--exclude-moduleref=libc \
		--exclude-moduleref=Microsoft.DiaSymReader.Native.x86.dll \
		--exclude-moduleref=Microsoft.DiaSymReader.Native.amd64.dll \
		--exclude-moduleref=mscoree.dll \
		--exclude-moduleref=mscorwks.dll \
		--exclude-moduleref=NTDLL.DLL \
		--exclude-moduleref=ntdll.dll \
		--exclude-moduleref=ntdll \
		--exclude-moduleref=ole32.dll \
		--exclude-moduleref=Ole32 \
		--exclude-moduleref=wintrust.dll \
		--exclude-moduleref=sfc.dll

%:
	dh --with cli $@ 
